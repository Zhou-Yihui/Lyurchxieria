<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>SCMS - 写信</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- 富文本 -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.min.css" rel="stylesheet">
  <!-- 自动补全 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--bg:#0b0c2a;--fg:#fff;--card:rgba(255,255,255,.08);--accent:#f0c000;}
    body.light{--bg:#f5f5f5;--fg:#111;--card:rgba(0,0,0,.05);}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Microsoft YaHei,Helvetica,Arial;}
    header{height:56px;background:var(--card);display:flex;align-items:center;padding:0 20px;justify-content:space-between;}
    main{max-width:900px;margin:20px auto;padding:0 10px;}
    .ql-container{border-radius:0 0 6px 6px;background:#fff;color:#000;}
    .ql-toolbar{border-radius:6px 6px 0 0;background:#fff;}
    #sendBtn{background:var(--accent);color:#000;border:none;padding:10px 24px;font-size:16px;border-radius:6px;cursor:pointer;}
    #sendBtn:hover{background:#ffd700;}
    #draftInfo{font-size:12px;color:#aaa;margin-left:10px;}
    #attachList{margin-top:8px;}
    .attach-item{display:inline-flex;align-items:center;background:var(--card);padding:4px 8px;border-radius:4px;margin-right:6px;margin-bottom:6px;}
    .attach-item .remove{margin-left:6px;cursor:pointer;color:#ff9;}
    #autoSaveMsg{color:#7f7;font-size:12px;margin-left:10px;}
    .tt-dropdown-menu{width:100%;background:#fff;color:#111;border:1px solid #ddd;border-radius:4px;max-height:200px;overflow-y:auto;}
    .tt-suggestion{padding:6px 10px;cursor:pointer;}.tt-suggestion:hover{background:#f2f2f2;}
    @media(max-width:600px){header{flex-wrap:wrap;height:auto;padding:8px;}main{margin:10px auto;}}
  </style>
  <script>(()=>{if(!localStorage.getItem('SCMS-currentUser'))location.href='index.html';})();</script>
</head>
<body>
<header>
  <div>
    <button onclick="location.href='home.html'">← 主页</button>
    <button onclick="location.href='inbox.html'">📥 收件箱</button>
    <button onclick="location.href='sent.html'">📤 发件箱</button>
  </div>
  <div>
    <button id="themeBtn" onclick="toggleTheme()">🌓 主题</button>
    <button onclick="logout()">退出</button>
  </div>
</header>

<main>
  <h2>✉️ 写信</h2>

  <!-- 收件人 + 自动补全 -->
  <label class="form-label">收件人</label>
  <input id="to" class="form-control mb-2" placeholder="输入邮箱或姓名" autocomplete="off">

  <!-- 主题 -->
  <label class="form-label">主题</label>
  <input id="subject" class="form-control mb-2" placeholder="主题">

  <!-- 富文本正文 -->
  <label class="form-label">正文</label>
  <div id="editor"></div>
  <input type="hidden" id="body">

  <!-- 附件占位 -->
  <div class="d-flex align-items-center mt-2">
    <button type="button" class="btn btn-sm btn-secondary" onclick="selectAttach()">📎 附件</button>
    <input type="file" id="attachInput" multiple style="display:none;" onchange="onAttach()">
    <span id="attachList"></span>
  </div>

  <!-- 操作栏 -->
  <div class="d-flex align-items-center mt-3">
    <button id="sendBtn" onclick="sendMail()">发送</button>
    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="saveDraft()">存草稿</button>
    <span id="draftInfo"></span>
    <span id="autoSaveMsg"></span>
  </div>
</main>

<!-- ====== 脚本 ====== -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========== 基础 ========== */
const u = localStorage.getItem('SCMS-currentUser');
const supabase = supabase.createClient(
  'https://mmlbjwdbgmhfkrrtehyl.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbGJqd2RiZ21oZmtycnRlaHlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDkxNTksImV4cCI6MjA3Njk4NTE1OX0.0bLCXnZYBgS-7nTZ_-cv-4s_26TcnC_o-TmlUEDh5yU'
);
async function getUsers(){
  const { data, error } = await supabase.from('users').select('*');
  if(error){ console.error(error); return {}; }
  return data.reduce((acc,u)=>(acc[u.username]=u, acc), {});
}
async function setUsers(users){
  const list = Object.values(users);
  const { error } = await supabase.from('users').upsert(list);
  if(error) console.error(error);
}
function toggleTheme(){
  document.body.classList.toggle('light');
  localStorage.setItem('SCMS-theme', document.body.classList.contains('light')?'light':'dark');
}
(function(){
  if(localStorage.getItem('SCMS-theme')==='light') document.body.classList.add('light');
})();
function logout(){
  localStorage.removeItem('SCMS-currentUser');
  location.href='index.html';
}

/* ========== 通讯录自动补全 ========== */
const contacts = [
  {name:'Alice', email:'alice@lyurchxieria.com'},
  {name:'Bob',   email:'bob@lyurchxieria.com'},
  {name:'Dev组', email:'dev@lyurchxieria.com'}
];
const bh = new Bloodhound({
  datumTokenizer: d => Bloodhound.tokenizers.whitespace(d.name + ' ' + d.email),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  local: contacts
});
bh.initialize();
$('#to').typeahead({minLength:1,highlight:true},{
  name: 'contacts',
  displayKey: 'email',
  source: bh.ttAdapter(),
  templates: { suggestion: d => `<div>${d.name} &lt;${d.email}&gt;</div>` }
});

/* ========== 富文本编辑器 ========== */
const quill = new Quill('#editor', {
  theme: 'snow',
  placeholder: '写点什么…',
  modules: {
    toolbar: [
      [{header: [1, 2, 3, false]}],
      ['bold', 'italic', 'underline', 'strike'],
      ['blockquote', 'code-block'],
      [{list: 'ordered'}, {list: 'bullet'}],
      ['link', 'image'],
      ['clean']
    ]
  }
});
quill.on('text-change', ()=> document.getElementById('body').value = quill.root.innerHTML);

/* ========== 附件占位 ========== */
let attachFiles = [];
function selectAttach(){ document.getElementById('attachInput').click(); }
function onAttach(){
  const files = Array.from(this.files);
  files.forEach(f=>attachFiles.push(f));
  renderAttach();
}
function renderAttach(){
  const html = attachFiles.map((f,i)=>`
    <span class="attach-item">${f.name}
      <span class="remove" onclick="attachFiles.splice(${i},1);renderAttach()">✖</span>
    </span>`).join('');
  document.getElementById('attachList').innerHTML = html;
}

/* ========== 自动保存草稿 ========== */
let draftTimer = setInterval(async ()=>{
  if(quill.getLength()<=1) return;
  await saveDraft(true);
  document.getElementById('autoSaveMsg').textContent = '✔ 已自动保存';
  setTimeout(()=>document.getElementById('autoSaveMsg').textContent='',2000);
}, 30000);

async function saveDraft(isAuto = false){
  const users = await getUsers();
  const draft = {
    to: document.getElementById('to').value.trim(),
    subject: document.getElementById('subject').value.trim(),
    content: document.getElementById('body').value,
    date: Date.now(),
    attachments: attachFiles.map(f=>f.name)
  };
  if(!users[u].drafts) users[u].drafts = [];
  users[u].drafts.push(draft);
  await setUsers(users);
  document.getElementById('draftInfo').textContent = isAuto ? '' : '草稿已保存';
}

/* ========== 发送邮件 ========== */
async function sendMail(){
  const to    = document.getElementById('to').value.trim();
  const subj  = document.getElementById('subject').value.trim();
  const body  = document.getElementById('body').value.trim();
  if(!to || !subj || !body) return alert('请填写完整！');

  const users = await getUsers();
  if(!users[to]){
    users[to] = {username:to, password:'123456', inbox:[], sent:[], drafts:[], spam:[], trash:[]};
  }
  const mail = {
    from: u,
    to: to,
    subject: subj,
    content: body,
    date: Date.now(),
    read: false,
    star: false,
    attachments: attachFiles.map(f=>f.name)
  };
  users[to].inbox.push(mail);
  users[u].sent.push(mail);
  await setUsers(users);

  // 可选：真实邮件投递（Worker 口）
  try{
    await fetch('https://scms-send.lyurchxieria.com', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({to:to, subject:subj, text:body})
    });
  }catch(e){ console.log('真实邮件投递失败',e); }

  alert('发送成功！');
  location.href='sent.html';
}
</script>
</body>
</html>
