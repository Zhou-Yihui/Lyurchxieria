<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ˜Ÿé—¨å›½å®¶é‚®ä»¶ç³»ç»Ÿ (SCMS)</title>
<style>
/* ğŸŒŒ SCMS æ˜Ÿé—¨ Webmail æ ·å¼ */
body {
    font-family: "Microsoft YaHei", sans-serif;
    background: linear-gradient(120deg, #0a0f24, #142850, #27496d);
    color: #fff;
    margin:0;
    padding:0;
    text-align:center;
}
header {
    padding:20px 0;
    background: rgba(255,255,255,0.05);
    box-shadow:0 0 10px rgba(0,0,0,0.3);
}
section {
    width:90%;
    max-width:700px;
    background: rgba(255,255,255,0.08);
    border-radius:15px;
    padding:20px;
    margin:30px auto;
}
input, textarea, button {
    width:80%;
    padding:10px;
    margin:5px 0;
    border:none;
    border-radius:8px;
    font-size:1em;
}
textarea { height:120px; background:#111; color:#fff; }
button {
    background-color:#3ba9ff;
    color:white;
    cursor:pointer;
    transition:0.3s;
}
button:hover { background-color:#5ac8ff; }
#mailbox,#inbox,#sent-box,#send-mail { display:none; text-align:left; }
.mail-item { padding:8px; border-bottom:1px solid #333; cursor:pointer; }
.mail-item:hover { background:#222; }
</style>
</head>
<body>

<header>
  <h1>æ˜Ÿé—¨å›½å®¶é‚®ä»¶ç³»ç»Ÿ</h1>
  <h3>StarGate Civilization Mail System (SCMS)</h3>
</header>

<!-- ç™»å½•/æ³¨å†Œ -->
<section id="auth-section">
  <h3>ç™»å½•æˆ–æ³¨å†Œè´¦æˆ· / Login or Register</h3>
  <input id="username" placeholder="ç”¨æˆ·å / Username" /><br />
  <input id="password" type="password" placeholder="å¯†ç  / Password" /><br />
  <button onclick="login()">ç™»å½• / Login</button>
  <button onclick="register()">æ³¨å†Œ / Register</button>
  <p id="auth-msg" style="color:#f0c000;"></p>
</section>

<!-- é‚®ç®±ä¸»ç•Œé¢ -->
<section id="mailbox">
  <h3>æ¬¢è¿å›æ¥ï¼Œ<span id="user"></span></h3>
  <button onclick="showInbox()">ğŸ“¥ æ”¶ä»¶ç®± / Inbox</button>
  <button onclick="showSent()">ğŸ“¤ å‘ä»¶ç®± / Sent</button>
  <button onclick="showSendMail()">âœ‰ï¸ å†™ä¿¡ / Compose</button>
  <button onclick="logout()">é€€å‡º / Logout</button>
</section>

<!-- æ”¶ä»¶ç®± -->
<section id="inbox">
  <h3>æ”¶ä»¶ç®± / Inbox</h3>
  <div id="inbox-list"></div>
</section>

<!-- å‘ä»¶ç®± -->
<section id="sent-box">
  <h3>å‘ä»¶ç®± / Sent</h3>
  <div id="sent-list"></div>
</section>

<!-- å†™ä¿¡ -->
<section id="send-mail">
  <h3>æ’°å†™æ–°é‚®ä»¶ / Compose New Mail</h3>
  <input id="to" placeholder="æ”¶ä»¶äºº / To" /><br />
  <input id="subject" placeholder="ä¸»é¢˜ / Subject" /><br />
  <textarea id="content" placeholder="æ­£æ–‡ / Message"></textarea><br />
  <button onclick="sendMail()">å‘é€ / Send</button>
  <p id="send-msg" style="color:#f0c000;"></p>
</section>

<script>
const api = "http://localhost:3000/api"; // åç«¯åœ°å€ï¼Œéƒ¨ç½²åä¿®æ”¹ä¸º HTTPS

// æ³¨å†Œ
async function register(){
  const u = username.value.trim(), p = password.value.trim();
  if(!u||!p){ authMsg("ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º / Username & Password required"); return; }
  const res = await fetch(api+"/register",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:u,password:p})
  });
  const data = await res.json();
  authMsg(data.message);
}

// ç™»å½•
async function login(){
  const u = username.value.trim(), p = password.value.trim();
  if(!u||!p){ authMsg("ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º / Username & Password required"); return; }
  const res = await fetch(api+"/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:u,password:p})
  });
  const data = await res.json();
  if(data.success){
    localStorage.setItem("user",u);
    document.getElementById("user").textContent = u;
    showMailbox();
  }else authMsg(data.message);
}

// é€€å‡º
function logout(){
  localStorage.removeItem("user");
  location.reload();
}

// æ˜¾ç¤ºä¸»ç•Œé¢
function showMailbox(){
  document.getElementById("auth-section").style.display="none";
  document.getElementById("mailbox").style.display="block";
  showInbox();
}

// æ˜¾ç¤ºæ”¶ä»¶ç®±
async function showInbox(){
  hideAll();
  inbox.style.display="block";
  const u = localStorage.getItem("user");
  const res = await fetch(api+"/inbox/"+u);
  const mails = await res.json();
  inboxList.innerHTML = mails.length ? mails.map(m=>`<div class="mail-item">æ¥è‡ª ${m.from} ï¼š ${m.subject}</div>`).join('') : "æš‚æ— é‚®ä»¶ / No mails";
}

// æ˜¾ç¤ºå‘ä»¶ç®±
async function showSent(){
  hideAll();
  sentBox.style.display="block";
  const u = localStorage.getItem("user");
  const res = await fetch(api+"/sent/"+u);
  const mails = await res.json();
  sentList.innerHTML = mails.length ? mails.map(m=>`<div class="mail-item">å‘ç»™ ${m.to} ï¼š ${m.subject}</div>`).join('') : "æš‚æ— å·²å‘é€é‚®ä»¶ / No sent mails";
}

// æ˜¾ç¤ºå†™ä¿¡
function showSendMail(){
  hideAll();
  sendMailSection.style.display="block";
}

// å‘é€é‚®ä»¶
async function sendMail(){
  const from = localStorage.getItem("user");
  const mail = {from,to:to.value,subject:subject.value,content:content.value};
  if(!mail.to||!mail.subject||!mail.content){ sendMsg.textContent="æ”¶ä»¶äºº/ä¸»é¢˜/å†…å®¹ä¸èƒ½ä¸ºç©º / All fields required"; return; }
  const res = await fetch(api+"/send",{ 
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(mail)
  });
  const data = await res.json();
  sendMsg.textContent=data.message;
  to.value=subject.value=content.value="";
}

// éšè—æ‰€æœ‰é‚®ä»¶ç•Œé¢
function hideAll(){ inbox.style.display=sentBox.style.display=sendMailSection.style.display="none"; }

// é¡µé¢åŠ è½½æ£€æŸ¥ç™»å½•çŠ¶æ€
window.onload = ()=>{
  const user = localStorage.getItem("user");
  if(user){
    document.getElementById("user").textContent=user;
    showMailbox();
  }
};
</script>

</body>
</html>