<!DOCTYPE html>
<html lang="zh-CN"><head><meta charset="UTF-8"><title>SCMS - 登录</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>:root{--bg:#0b0c2a;--fg:#fff;--card:rgba(255,255,255,.08);--accent:#f0c000;}body.light{--bg:#f5f5f5;--fg:#111;--card:rgba(0,0,0,.05);}
body{margin:0;background:var(--bg);color:var(--fg);font-family:Microsoft YaHei;display:flex;flex-direction:column;min-height:100vh;}
header{padding:20px;background:var(--card);display:flex;align-items:center;justify-content:space-between;}
#themeBtn{border:1px solid var(--accent);color:var(--accent);background:0 0;padding:6px 12px;border-radius:4px;cursor:pointer;}
main{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;}
.card{background:var(--card);border-radius:12px;padding:25px;width:100%;max-width:400px;}
h2{margin:0 0 15px;font-size:20px;font-weight:600;}
input{width:100%;padding:10px;margin:8px 0;border:none;border-radius:6px;background:#111;color:var(--fg);}
body.light input{background:#fff;color:#111;}
.btn-group{display:flex;gap:8px;margin-top:15px;}
.btn-group button{flex:1;padding:10px;border:none;border-radius:6px;background:var(--accent);color:#000;font-size:16px;cursor:pointer;}
.btn-group button:hover{background:#ffd700;}
#msg{height:20px;color:#ff9;margin-top:8px;font-size:14px;}
footer{padding:15px;text-align:center;font-size:12px;color:#aaa;}
#capacityBar{width:100%;height:6px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:8px;overflow:hidden;}
#capacityUsed{height:100%;background:var(--accent);width:0%;}
</style>
</head><body>
<header>
  <span><i class="fa fa-envelope"></i> 星门邮件系统</span>
  <button id="themeBtn" onclick="toggleTheme()">🌓 主题</button>
</header>

<main>
  <div class="card">
    <h2>登录 / 注册</h2>
    <input id="username" placeholder="用户名" autocomplete="off">
    <input id="password" type="password" placeholder="密码" autocomplete="off">
    <div class="btn-group">
      <button onclick="login()">登录</button>
      <button onclick="register()">注册</button>
    </div>
    <p id="msg"></p>
    <div id="capacityBar"><div id="capacityUsed"></div></div>
    <small id="capacityText">容量：0 / 1000 封</small>
  </div>
</main>

<footer>© 2024 StarGate Civilization Mail System</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<script>
const supabase = supabase.createClient(
  'https://mmlbjwdbgmhfkrrtehyl.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbGJqd2RiZ21oZmtycnRlaHlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDkxNTksImV4cCI6MjA3Njk4NTE1OX0.0bLCXnZYBgS-7nTZ_-cv-4s_26TcnC_o-TmlUEDh5yU'
);
async function getUsers(){
  const { data, error } = await supabase.from('users').select('*');
  if(error){ console.error(error); return {}; }
  return data.reduce((acc,u)=>(acc[u.username]=u, acc), {});
}
async function setUsers(users){
  const list = Object.values(users);
  const { error } = await supabase.from('users').upsert(list);
  if(error) console.error(error);
}
const msg = txt => document.getElementById('msg').textContent = txt;

/* 主题切换 */
function toggleTheme(){
  document.body.classList.toggle('light');
  localStorage.setItem('SCMS-theme', document.body.classList.contains('light')?'light':'dark');
}
(function(){
  if(localStorage.getItem('SCMS-theme')==='light') document.body.classList.add('light');
})();

/* 容量条 */
async function loadCapacity(){
  const users = await getUsers();
  const total = Object.values(users).reduce((s,u)=>s+u.inbox.length+u.sent.length,0);
  const pct = Math.min(100, Math.floor(total / 1000 * 100));
  document.getElementById('capacityUsed').style.width = pct + '%';
  document.getElementById('capacityText').textContent = `容量：${total} / 1000 封`;
}
loadCapacity();

/* 登录/注册 */
async function register(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  if(!u||!p) return msg('用户名和密码不能为空');
  const users = await getUsers();
  if(users[u]) return msg('用户已存在');
  users[u] = {username:u, password:p, inbox:[], sent:[], drafts:[], spam:[], trash:[]};
  await setUsers(users);
  msg('注册成功，请登录');
  loadCapacity();
}
async function login(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  const users = await getUsers();
  if(users[u] && users[u].password === p){
    localStorage.setItem('SCMS-currentUser', u);
    location.href='home.html';
  }else{
    msg('用户名或密码错误');
  }
}
</script>
</body></html>
