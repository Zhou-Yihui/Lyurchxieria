<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>星门国家邮件系统 | SCMS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:"Microsoft YaHei",sans-serif;background:#0b0c2a;color:#fff;text-align:center;margin:0}
    header{padding:25px;background:rgba(255,255,255,.05)}
    section{width:90%;max-width:400px;margin:30px auto;background:rgba(255,255,255,.08);padding:20px;border-radius:10px}
    input,button{width:80%;padding:10px;margin:8px 0;border:none;border-radius:5px}
    button{background:#f0c000;color:#000;font-size:16px;cursor:pointer}
    button:hover{background:#ffd700}
    #auth-msg{color:#ff9;margin-top:10px;height:20px}
  </style>
  <!-- 1. 正确加载 Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>星门国家邮件系统</h1>
    <h3>StarGate Civilization Mail System</h3>
  </header>

  <section id="auth-section">
    <input id="username" autocomplete="off" placeholder="用户名 / Username" />
    <input id="password" type="password" autocomplete="off" placeholder="密码 / Password" />
    <button id="btn-login">登录 / Login</button>
    <button id="btn-reg">注册 / Register</button>
    <p id="auth-msg"></p>
  </section>

  <script>
    /* ===== 2. 初始化客户端 ===== */
    const supabase = window.supabase.createClient(
      'https://mmlbjwdbgmhfkrrtehyl.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbGJqd2RiZ21oZmtycnRlaHlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDkxNTksImV4cCI6MjA3Njk4NTE1OX0.0bLCXnZYBgS-7nTZ_-cv-4s_26TcnC_o-TmlUEDh5yU'
    );

    /* ===== 3. 工具函数 ===== */
    const msg = txt => document.getElementById('auth-msg').textContent = txt;

    /* ===== 4. 注册 ===== */
    document.getElementById('btn-reg').addEventListener('click', async () => {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      if (!user || !pass) return msg('用户名和密码不能为空');

      /* Supabase 认证表默认字段是 email，我们用 email 字段存用户名，后面加 @scms.local 后缀即可 */
      const email = `${user}@scms.local`;
      const { data, error } = await supabase.auth.signUp({ email, password: pass });
      if (error) return msg('注册失败：' + error.message);
      /* 注册成功直接登录并跳转 */
      localStorage.setItem('SCMS-currentUser', user);
      location.href = 'home.html';
    });

    /* ===== 5. 登录 ===== */
    document.getElementById('btn-login').addEventListener('click', async () => {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      if (!user || !pass) return msg('用户名和密码不能为空');

      const email = `${user}@scms.local`;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) return msg('登录失败：' + error.message);
      localStorage.setItem('SCMS-currentUser', user);
      location.href = 'home.html';
    });
  </script>
</body>
</html>
