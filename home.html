<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>SCMS - 主页</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>:root{--bg:#0b0c2a;--fg:#fff;--card:rgba(255,255,255,.08);--accent:#f0c000;}body.light{--bg:#f5f5f5;--fg:#111;--card:rgba(0,0,0,.05);}
body{margin:0;background:var(--bg);color:var(--fg);font-family:Microsoft YaHei;display:flex;flex-direction:column;height:100vh;}
header{height:56px;background:var(--card);display:flex;align-items:center;padding:0 20px;justify-content:space-between;}
main{display:flex;flex:1;overflow:hidden;}aside{width:220px;background:var(--card);padding:10px;display:flex;flex-direction:column;gap:8px;}
aside a{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:6px;text-decoration:none;color:var(--fg);}
aside a:hover{background:rgba(255,255,255,.1);}aside .badge{background:var(--accent);color:#000;font-size:12px;padding:2px 6px;border-radius:10px;}
#content{flex:1;padding:20px;}#themeBtn{border:1px solid var(--accent);color:var(--accent);background:0 0;padding:4px 10px;border-radius:4px;cursor:pointer;}
#capacityBar{height:6px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:6px;overflow:hidden;}#capacityUsed{height:100%;background:var(--accent);width:0%;}
#mailList{display:flex;flex-direction:column;gap:8px;}.mail{padding:10px;background:var(--card);border-radius:6px;cursor:pointer;}.mail:hover{background:rgba(255,255,255,.1);}</style>
<script>(()=>{if(!localStorage.getItem("SCMS-currentUser"))location.href='index.html';})();</script>
</head><body>
<header>
  <div>👤 <span id="userName"></span></div>
  <div>
    <button id="themeBtn" onclick="toggleTheme()">🌓 主题</button>
    <button onclick="logout()">退出</button>
  </div>
</header>
<main>
  <aside>
    <a href="inbox.html"><span><i class="fa fa-inbox"></i> 收件箱</span><span class="badge" id="inboxBadge">0</span></a>
    <a href="sent.html"><span><i class="fa fa-paper-plane"></i> 发件箱</span><span class="badge" id="sentBadge">0</span></a>
    <a href="compose.html"><span><i class="fa fa-edit"></i> 写信</span></a>
    <div style="margin-top:auto;font-size:12px;">邮箱容量
      <div id="capacityBar"><div id="capacityUsed"></div></div>
    </div>
  </aside>
  <section id="content">
    <h2>📬 今天想做什么？</h2>
    <div id="mailList"></div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const u = localStorage.getItem('SCMS-currentUser');
const supabase = supabase.createClient(
  'https://mmlbjwdbgmhfkrrtehyl.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbGJqd2RiZ21oZmtycnRlaHlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDkxNTksImV4cCI6MjA3Njk4NTE1OX0.0bLCXnZYBgS-7nTZ_-cv-4s_26TcnC_o-TmlUEDh5yU'
);
async function getUsers(){
  const { data, error } = await supabase.from('users').select('*');
  if(error){ console.error(error); return {}; }
  return data.reduce((acc,u)=>(acc[u.username]=u, acc), {});
}
async function setUsers(users){
  const list = Object.values(users);
  const { error } = await supabase.from('users').upsert(list);
  if(error) console.error(error);
}
function toggleTheme(){
  document.body.classList.toggle('light');
  localStorage.setItem('SCMS-theme', document.body.classList.contains('light')?'light':'dark');
}
(function(){
  if(localStorage.getItem('SCMS-theme')==='light') document.body.classList.add('light');
})();
function logout(){
  localStorage.removeItem('SCMS-currentUser');
  location.href='index.html';
}
(async ()=>{
  const users = await getUsers();
  const me = users[u];
  if(!me) return;
  document.getElementById('userName').textContent = u;
  document.getElementById('inboxBadge').textContent = me.inbox.filter(m=>!m.read).length;
  document.getElementById('sentBadge').textContent = me.sent.length;
  const total = me.inbox.length + me.sent.length;
  const pct = Math.min(100, Math.floor(total / 1000 * 100));
  document.getElementById('capacityUsed').style.width = pct + '%';
  const latest = me.inbox.slice(-5).reverse();
  const html = latest.length ? latest.map(m=>`
    <div class="mail" onclick="location.href='inbox.html'">
      <div><b>${m.from}</b> · ${m.subject}</div>
      <small>${new Date(m.date).toLocaleString()}</small>
    </div>`).join('') : '<p>暂无邮件</p>';
  document.getElementById('mailList').innerHTML = html;
})();
</script></body></html>
